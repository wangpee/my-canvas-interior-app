import React, { useState, useRef, useEffect } from 'react';
import { Upload, Image as ImageIcon, Sparkles, RefreshCw, Download, ArrowRight, Layout, Palette, X, AlertCircle, Wand2, SlidersHorizontal, Check, Plus, PaintBucket } from 'lucide-react';

// --- API CONFIGURATION ---
const API_KEY = ""; // Injected by environment

// --- TYPES ---
type DesignStyle = {
  id: string;
  name: string;
  description: string;
  promptModifier: string;
  color: string;
};

type AppState = 'landing' | 'upload' | 'styles' | 'generating' | 'results';

// --- STYLES DATA ---
const STYLES: DesignStyle[] = [
  {
    id: 'modern',
    name: 'Modern Minimalist',
    description: 'Clean lines, neutral colors, and functional furniture.',
    promptModifier: 'in a modern minimalist style, with clean lines, neutral color palette (whites, greys, warm wood), decluttered look, high-end modern furniture, soft natural lighting',
    color: 'bg-stone-100 text-stone-800'
  },
  {
    id: 'boho',
    name: 'Bohemian Chic',
    description: 'Eclectic, colorful, with organic textures and plants.',
    promptModifier: 'in a bohemian chic style, with rattan furniture, macrame textures, indoor plants, warm earth tones, eclectic patterns, cozy rugs, relaxed atmosphere',
    color: 'bg-orange-50 text-orange-900'
  },
  {
    id: 'industrial',
    name: 'Industrial Loft',
    description: 'Raw materials, exposed elements, and metal accents.',
    promptModifier: 'in an industrial loft style, with exposed brick, metal accents, leather furniture, concrete textures, edison bulb lighting, urban aesthetic',
    color: 'bg-slate-200 text-slate-800'
  },
  {
    id: 'scandi',
    name: 'Scandinavian',
    description: 'Bright, airy, functional with warm wood tones.',
    promptModifier: 'in a scandinavian style, hygge atmosphere, light wood floors, white walls, functional comfortable furniture, cozy textiles, bright and airy',
    color: 'bg-blue-50 text-blue-900'
  },
  {
    id: 'midcentury',
    name: 'Mid-Century Modern',
    description: 'Retro 50s/60s vibes with organic curves.',
    promptModifier: 'in a mid-century modern style, with teak wood furniture, tapered legs, olive green and mustard yellow accents, retro organic shapes, iconic design pieces',
    color: 'bg-amber-100 text-amber-900'
  },
  {
    id: 'japandi',
    name: 'Japandi',
    description: 'Fusion of Japanese rustic minimalism and Scandinavian functionality.',
    promptModifier: 'in a Japandi style, blend of Japanese rustic minimalism and Scandinavian functionality, wabi-sabi aesthetic, muted colors, low profile furniture, natural materials',
    color: 'bg-stone-200 text-stone-800'
  }
];

// --- HELPER COMPONENTS ---

const Spinner = () => (
  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
);

const ComparisonSlider = ({ beforeImage, afterImage }: { beforeImage: string; afterImage: string }) => {
  const [sliderPosition, setSliderPosition] = useState(50);
  const containerRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);

  const handleMouseDown = () => { isDragging.current = true; };
  const handleMouseUp = () => { isDragging.current = false; };
  
  const handleMouseMove = (e: React.MouseEvent | React.TouchEvent) => {
    if (!isDragging.current || !containerRef.current) return;
    
    const rect = containerRef.current.getBoundingClientRect();
    const clientX = 'touches' in e ? e.touches[0].clientX : (e as React.MouseEvent).clientX;
    const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
    const percentage = (x / rect.width) * 100;
    
    setSliderPosition(percentage);
  };

  useEffect(() => {
    document.addEventListener('mouseup', handleMouseUp);
    document.addEventListener('touchend', handleMouseUp);
    return () => {
      document.removeEventListener('mouseup', handleMouseUp);
      document.removeEventListener('touchend', handleMouseUp);
    };
  }, []);

  return (
    <div 
      ref={containerRef}
      className="relative w-full h-[300px] md:h-[500px] rounded-xl overflow-hidden cursor-ew-resize select-none shadow-xl border border-gray-200"
      onMouseMove={handleMouseMove}
      onTouchMove={handleMouseMove}
      onMouseDown={handleMouseDown}
      onTouchStart={handleMouseDown}
    >
      {/* After Image (Background) */}
      <img 
        src={afterImage} 
        alt="Redesigned Room" 
        className="absolute top-0 left-0 w-full h-full object-cover transition-opacity duration-300" 
      />

      {/* Before Image (Clipped) */}
      <div 
        className="absolute top-0 left-0 h-full overflow-hidden border-r-2 border-white"
        style={{ width: `${sliderPosition}%` }}
      >
        <img 
          src={beforeImage} 
          alt="Original Room" 
          className="absolute top-0 left-0 max-w-none h-full object-cover"
          style={{ width: containerRef.current?.offsetWidth }}
        />
        <div className="absolute top-4 left-4 bg-black/60 text-white text-xs font-bold px-2 py-1 rounded backdrop-blur-sm">
          ORIGINAL
        </div>
      </div>

      {/* Slider Handle */}
      <div 
        className="absolute top-0 bottom-0 w-1 bg-white cursor-ew-resize flex items-center justify-center shadow-[0_0_10px_rgba(0,0,0,0.5)]"
        style={{ left: `${sliderPosition}%` }}
      >
        <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-lg transform -translate-x-1/2">
          <SlidersHorizontal className="w-4 h-4 text-indigo-600" />
        </div>
      </div>

      <div className="absolute top-4 right-4 bg-indigo-600/90 text-white text-xs font-bold px-2 py-1 rounded backdrop-blur-sm shadow-sm">
        REDESIGNED
      </div>
    </div>
  );
};

// --- MAIN COMPONENT ---

export default function InteriorAIApp() {
  const [appState, setAppState] = useState<AppState>('landing');
  const [uploadedImage, setUploadedImage] = useState<string | null>(null);
  
  // Changed: Store array of images instead of single image
  const [generatedImages, setGeneratedImages] = useState<string[]>([]);
  const [selectedImageIndex, setSelectedImageIndex] = useState<number>(0);
  const [isGeneratingMore, setIsGeneratingMore] = useState(false);
  
  // Refinement State
  const [refineTarget, setRefineTarget] = useState<string>('walls');
  const [refineColor, setRefineColor] = useState<string>('');
  const [isRefining, setIsRefining] = useState(false);

  const [selectedStyle, setSelectedStyle] = useState<DesignStyle | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loadingText, setLoadingText] = useState('Analyzing your room...');

  const scrollContainerRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to selected image when index changes or new images are added
  useEffect(() => {
    if (scrollContainerRef.current && generatedImages.length > 0) {
      // The first child is the "Generate More" button, so we offset by 1
      const selectedChildIndex = selectedImageIndex + 1;
      const childNode = scrollContainerRef.current.children[selectedChildIndex] as HTMLElement;
      
      if (childNode) {
        childNode.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'nearest', 
          inline: 'center' 
        });
      }
    }
  }, [selectedImageIndex, generatedImages.length]);

  // --- HANDLERS ---

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        setError("Image is too large. Please upload an image under 5MB.");
        return;
      }

      const reader = new FileReader();
      reader.onloadend = () => {
        setUploadedImage(reader.result as string);
        setAppState('styles');
        setError(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleReset = () => {
    setAppState('landing');
    setUploadedImage(null);
    setGeneratedImages([]);
    setSelectedImageIndex(0);
    setSelectedStyle(null);
    setRefineColor('');
    setError(null);
    setIsGeneratingMore(false);
    setIsRefining(false);
  };

  const generateDesign = async () => {
    if (!uploadedImage || !selectedStyle) return;

    setAppState('generating');
    setError(null);
    setLoadingText('Preparing design variations...');

    try {
      const base64Data = uploadedImage.split(',')[1];
      
      const promptBase = `Redesign this interior space ${selectedStyle.promptModifier}. 
      Keep the structural layout (walls, windows, ceiling, floor perspective) exactly the same. 
      Replace the furniture, decor, and color scheme to match the requested style. 
      Photorealistic, high quality, 8k resolution, interior design photography.`;

      // Create 3 slightly different prompts to encourage variety
      const prompts = [
        `${promptBase} Focus on perfect lighting and classic interpretation of the style.`,
        `${promptBase} Make it feel cozy, lived-in, and warm.`,
        `${promptBase} Use a slightly more dramatic contrast and distinct furniture arrangement.`
      ];

      setLoadingText('Generating 3 unique variations...');

      // Execute requests in parallel
      const results = await Promise.allSettled(
        prompts.map(p => retryApiCall(p, base64Data))
      );

      // Collect successful images
      const successfulImages = results
        .filter((r): r is PromiseFulfilledResult<string | null> => r.status === 'fulfilled' && r.value !== null)
        .map(r => r.value as string);

      if (successfulImages.length > 0) {
        setGeneratedImages(successfulImages);
        setSelectedImageIndex(0);
        setAppState('results');
      } else {
        throw new Error("Failed to generate designs. Please try again.");
      }

    } catch (err: any) {
      console.error("Generation failed:", err);
      setError(err.message || "Failed to generate design. Please try again.");
      setAppState('styles');
    }
  };

  const generateMoreDesigns = async () => {
    if (!uploadedImage || !selectedStyle) return;

    setIsGeneratingMore(true);
    setError(null);

    try {
      const base64Data = uploadedImage.split(',')[1];
      
      const promptBase = `Redesign this interior space ${selectedStyle.promptModifier}. 
      Keep the structural layout (walls, windows, ceiling, floor perspective) exactly the same. 
      Replace the furniture, decor, and color scheme to match the requested style. 
      Photorealistic, high quality, 8k resolution, interior design photography.`;

      // Expanded modifiers list for more variety during continuous generation
      const modifiers = [
         "emphasizing natural light and airy feeling",
         "with a focus on cozy textures and soft fabrics",
         "highlighting architectural details with bold contrast",
         "using a monochromatic color scheme within the style",
         "adding subtle greenery and organic elements",
         "with a more luxurious and polished finish",
         "with a distinct and creative furniture layout",
         "incorporating statement lighting fixtures",
         "with a softer, more muted color palette",
         "maximizing the sense of space and flow",
         "with artistic decor accents and wall art",
         "focusing on symmetry and balance"
      ];
      
      // Shuffle and pick 3
      const shuffled = modifiers.sort(() => 0.5 - Math.random()).slice(0, 3);
      const prompts = shuffled.map(mod => `${promptBase} ${mod}`);

      const results = await Promise.allSettled(
        prompts.map(p => retryApiCall(p, base64Data))
      );

      const successfulImages = results
        .filter((r): r is PromiseFulfilledResult<string | null> => r.status === 'fulfilled' && r.value !== null)
        .map(r => r.value as string);

      if (successfulImages.length > 0) {
        // Appending new images
        const currentLength = generatedImages.length;
        setGeneratedImages(prev => [...prev, ...successfulImages]);
        // Switch view to the first of the NEW images to show progress
        setSelectedImageIndex(currentLength); 
      } else {
        setError("Failed to generate more variations. Please try again.");
      }
    } catch (err: any) {
      setError(err.message || "Failed to generate more designs.");
    } finally {
      setIsGeneratingMore(false);
    }
  };

  const handleRefine = async () => {
    const currentGeneratedImage = generatedImages[selectedImageIndex];
    if (!currentGeneratedImage || !refineColor.trim()) return;

    setIsRefining(true);
    setError(null);

    try {
      // Use the CURRENT generated image as the base for refinement
      const base64Data = currentGeneratedImage.split(',')[1];
      
      const prompt = `Change the ${refineTarget} to ${refineColor} in this room. 
      Keep the rest of the room, including layout, lighting, and other furniture, exactly the same. 
      Photorealistic, high quality interior design.`;

      const result = await retryApiCall(prompt, base64Data);

      if (result) {
        setGeneratedImages(prev => [...prev, result]);
        // Select the new refined image
        setSelectedImageIndex(generatedImages.length);
        // Optional: Clear color input after success? 
        // setRefineColor(''); 
      } else {
        throw new Error("Failed to refine design.");
      }
    } catch (err: any) {
      console.error("Refine failed:", err);
      setError(err.message || "Failed to update design.");
    } finally {
      setIsRefining(false);
    }
  };

  const retryApiCall = async (prompt: string, base64Data: string, retries = 3): Promise<string | null> => {
    const delays = [1000, 2000, 4000];
    
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { text: prompt },
                  { 
                    inlineData: { 
                      mimeType: "image/jpeg", 
                      data: base64Data 
                    } 
                  }
                ]
              }],
              generationConfig: {
                responseModalities: ["IMAGE"],
              }
            })
          }
        );

        if (!response.ok) {
           const errData = await response.json();
           throw new Error(errData.error?.message || `API Error: ${response.status}`);
        }

        const data = await response.json();
        const base64Image = data.candidates?.[0]?.content?.parts?.find((p: any) => p.inlineData)?.inlineData?.data;

        if (base64Image) {
          return `data:image/jpeg;base64,${base64Image}`;
        }
        
      } catch (e) {
        if (i === retries - 1) throw e;
        await new Promise(resolve => setTimeout(resolve, delays[i]));
      }
    }
    return null;
  };

  // --- VIEWS ---

  const renderLanding = () => (
    <div className="flex flex-col items-center justify-center min-h-[60vh] text-center px-4 animate-fade-in">
      <div className="w-20 h-20 bg-indigo-100 rounded-3xl flex items-center justify-center mb-8 shadow-lg transform rotate-3">
        <Wand2 className="w-10 h-10 text-indigo-600" />
      </div>
      <h1 className="text-4xl md:text-6xl font-bold text-gray-900 mb-6 tracking-tight">
        Redesign your room <br/> <span className="text-indigo-600">in seconds.</span>
      </h1>
      <p className="text-lg text-gray-600 max-w-2xl mb-10 leading-relaxed">
        Upload a photo of your room and let our AI interior designer generate 
        stunning variations in different architectural styles.
      </p>
      
      <div className="flex flex-col sm:flex-row gap-4">
        <label className="group relative flex items-center justify-center gap-3 bg-gray-900 text-white px-8 py-4 rounded-full text-lg font-semibold cursor-pointer hover:bg-gray-800 transition-all hover:scale-105 active:scale-95 shadow-xl">
          <Upload className="w-5 h-5" />
          <span>Upload Room Photo</span>
          <input 
            type="file" 
            accept="image/*" 
            onChange={handleImageUpload}
            className="hidden" 
          />
        </label>
      </div>

      <div className="mt-16 grid grid-cols-3 gap-4 md:gap-8 opacity-60">
        <div className="w-24 h-24 md:w-32 md:h-32 bg-gray-200 rounded-lg animate-pulse"></div>
        <div className="w-24 h-24 md:w-32 md:h-32 bg-gray-300 rounded-lg animate-pulse delay-75"></div>
        <div className="w-24 h-24 md:w-32 md:h-32 bg-gray-200 rounded-lg animate-pulse delay-150"></div>
      </div>
    </div>
  );

  const renderStyles = () => (
    <div className="max-w-4xl mx-auto px-4 py-8 animate-fade-in">
      <div className="flex items-center justify-between mb-8">
        <h2 className="text-2xl font-bold text-gray-900">Choose a Design Style</h2>
        <button 
          onClick={handleReset}
          className="text-gray-500 hover:text-red-500 flex items-center gap-2 text-sm transition-colors"
        >
          <X className="w-4 h-4" /> Cancel
        </button>
      </div>

      <div className="mb-8">
        <div className="relative aspect-video rounded-xl overflow-hidden shadow-lg bg-gray-100">
          <img 
            src={uploadedImage!} 
            alt="Uploaded Room" 
            className="w-full h-full object-cover" 
          />
          <div className="absolute top-4 left-4 bg-black/50 text-white px-3 py-1 rounded-full text-xs font-medium backdrop-blur-sm">
            Your Room
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
        {STYLES.map((style) => (
          <button
            key={style.id}
            onClick={() => setSelectedStyle(style)}
            className={`p-6 rounded-xl border-2 text-left transition-all duration-200 relative overflow-hidden group ${
              selectedStyle?.id === style.id 
                ? 'border-indigo-600 bg-indigo-50 shadow-md scale-[1.02]' 
                : 'border-gray-200 hover:border-indigo-300 hover:bg-gray-50'
            }`}
          >
            <div className={`w-10 h-10 rounded-full flex items-center justify-center mb-4 ${style.color}`}>
              <Palette className="w-5 h-5" />
            </div>
            <h3 className="font-bold text-gray-900 mb-1">{style.name}</h3>
            <p className="text-sm text-gray-600 leading-snug">{style.description}</p>
            
            {selectedStyle?.id === style.id && (
              <div className="absolute top-4 right-4 w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-white">
                <Sparkles className="w-3 h-3" />
              </div>
            )}
          </button>
        ))}
      </div>

      <div className="flex justify-end sticky bottom-4 z-10">
        <button
          onClick={generateDesign}
          disabled={!selectedStyle}
          className={`flex items-center gap-2 px-8 py-4 rounded-full text-lg font-bold text-white shadow-xl transition-all ${
            selectedStyle 
              ? 'bg-indigo-600 hover:bg-indigo-700 hover:scale-105 cursor-pointer' 
              : 'bg-gray-300 cursor-not-allowed'
          }`}
        >
          <Wand2 className="w-5 h-5" />
          Generate 3 Variations
        </button>
      </div>
    </div>
  );

  const renderGenerating = () => (
    <div className="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
      <div className="relative w-24 h-24 mb-8">
        <div className="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
        <div className="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
        <Sparkles className="absolute inset-0 m-auto text-indigo-600 animate-pulse" />
      </div>
      <h3 className="text-2xl font-bold text-gray-900 mb-2">Designing your space</h3>
      <p className="text-gray-500 animate-pulse">{loadingText}</p>
      
      <div className="mt-8 max-w-sm w-full bg-gray-100 rounded-full h-2 overflow-hidden">
        <div className="h-full bg-indigo-600 rounded-full animate-progress origin-left"></div>
      </div>
      
      <p className="text-xs text-gray-400 mt-4 max-w-xs">
        Generating 3 unique options... <br/>This takes about 10-15 seconds.
      </p>
    </div>
  );

  const renderResults = () => {
    const currentGeneratedImage = generatedImages[selectedImageIndex];

    return (
      <div className="max-w-6xl mx-auto px-4 py-8 animate-fade-in">
        <div className="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
          <div>
            <h2 className="text-3xl font-bold text-gray-900 mb-1">Your Redesigned Room</h2>
            <div className="flex items-center gap-2 text-gray-600">
              <span className="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                {selectedStyle?.name}
              </span>
              <span className="text-sm">Style applied</span>
            </div>
          </div>
          
          <div className="flex gap-3">
            <button 
              onClick={() => setAppState('styles')}
              className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-700 font-medium transition-colors"
            >
              <RefreshCw className="w-4 h-4" />
              Try Another Style
            </button>
            <button 
              onClick={handleReset}
              className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-700 font-medium transition-colors"
            >
              <Upload className="w-4 h-4" />
              New Room
            </button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Main Comparison Area */}
          <div className="lg:col-span-2">
            
            {/* Main Preview */}
            <div className="bg-white p-2 rounded-2xl shadow-sm border border-gray-100 mb-6">
               {uploadedImage && currentGeneratedImage && (
                 <ComparisonSlider beforeImage={uploadedImage} afterImage={currentGeneratedImage} />
               )}
            </div>
            
            {/* Variations Selector */}
            {generatedImages.length > 0 && (
              <div className="mb-6">
                <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wider">
                  Variations ({generatedImages.length})
                </h4>
                <div 
                  ref={scrollContainerRef}
                  className="flex gap-4 overflow-x-auto pb-4 px-1"
                >
                  
                  {/* Generate More Button - Moved to START so it's always accessible for continuous generation */}
                  <button 
                    onClick={generateMoreDesigns}
                    disabled={isGeneratingMore}
                    className="flex-shrink-0 w-28 h-20 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center gap-1 text-gray-500 hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-white"
                  >
                    {isGeneratingMore ? (
                       <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600"></div>
                    ) : (
                      <>
                        <Plus className="w-5 h-5" />
                        <span className="text-[10px] font-bold">GENERATE MORE</span>
                      </>
                    )}
                  </button>

                  {generatedImages.map((img, idx) => (
                    <button
                      key={idx}
                      onClick={() => setSelectedImageIndex(idx)}
                      className={`relative flex-shrink-0 w-28 h-20 rounded-lg overflow-hidden border-2 transition-all group ${
                        selectedImageIndex === idx 
                          ? 'border-indigo-600 ring-2 ring-indigo-200 scale-105' 
                          : 'border-gray-200 opacity-70 hover:opacity-100 hover:border-indigo-300'
                      }`}
                    >
                      <img src={img} alt={`Variation ${idx + 1}`} className="w-full h-full object-cover" />
                      <div className={`absolute inset-0 flex items-center justify-center bg-black/40 transition-opacity ${selectedImageIndex === idx ? 'opacity-100' : 'opacity-0'}`}>
                        {selectedImageIndex === idx && <Check className="w-6 h-6 text-white" />}
                      </div>
                      <div className="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-[10px] py-1 text-center font-medium">
                        Option {idx + 1}
                      </div>
                    </button>
                  ))}
                  
                </div>
              </div>
            )}
            
            <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
              <div className="text-sm text-blue-800">
                <p className="font-semibold mb-1">Design Tip:</p>
                <p>Click "Generate More" to see new variations. Use the customization tool on the right to tweak colors.</p>
              </div>
            </div>
          </div>

          {/* Sidebar Actions */}
          <div className="space-y-6">
            
            {/* Design Details Card */}
            <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
              <h3 className="font-bold text-gray-900 mb-4">Design Details</h3>
              
              <div className="space-y-4">
                <div>
                  <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Style</span>
                  <p className="font-medium text-gray-800">{selectedStyle?.name}</p>
                </div>
                
                <div>
                  <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Variation</span>
                  <p className="font-medium text-gray-800">Option {selectedImageIndex + 1}</p>
                </div>

                <button 
                  onClick={() => {
                    if (currentGeneratedImage) {
                      const link = document.createElement('a');
                      link.href = currentGeneratedImage;
                      link.download = `interior-ai-${selectedStyle?.id}-var${selectedImageIndex + 1}.jpg`;
                      link.click();
                    }
                  }}
                  className="w-full mt-4 flex items-center justify-center gap-2 bg-gray-900 hover:bg-black text-white px-4 py-3 rounded-lg font-medium transition-colors"
                >
                  <Download className="w-4 h-4" />
                  Download
                </button>
              </div>
            </div>

            {/* Customization Card */}
            <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm border-t-4 border-t-indigo-500">
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <PaintBucket className="w-5 h-5 text-indigo-600" />
                Customize Colors
              </h3>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Change</label>
                  <select 
                    value={refineTarget}
                    onChange={(e) => setRefineTarget(e.target.value)}
                    className="w-full p-2.5 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow"
                  >
                    <option value="walls">Walls</option>
                    <option value="furniture">Main Furniture</option>
                    <option value="sofa">Sofa / Seating</option>
                    <option value="cabinets">Cabinets / Storage</option>
                    <option value="floor">Flooring</option>
                    <option value="curtains">Curtains / Blinds</option>
                    <option value="rug">Rug / Carpet</option>
                  </select>
                </div>

                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">To Color / Material</label>
                  <input 
                    type="text"
                    value={refineColor}
                    onChange={(e) => setRefineColor(e.target.value)}
                    placeholder="e.g. Navy Blue, Sage Green, Oak"
                    className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow"
                  />
                </div>

                <button 
                  onClick={handleRefine}
                  disabled={isRefining || !refineColor.trim()}
                  className="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed text-white px-4 py-3 rounded-lg font-medium transition-colors"
                >
                  {isRefining ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                      <span>Updating...</span>
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-4 h-4" />
                      <span>Apply Change</span>
                    </>
                  )}
                </button>
                <p className="text-[10px] text-gray-400 text-center leading-tight">
                  This creates a new variation based on the currently selected image.
                </p>
              </div>
            </div>

          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900 font-sans selection:bg-indigo-100 selection:text-indigo-900">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
          <div 
            className="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity"
            onClick={handleReset}
          >
            <div className="bg-indigo-600 text-white p-1.5 rounded-lg">
              <Layout className="w-5 h-5" />
            </div>
            <span className="font-bold text-xl tracking-tight">Ax3InteriAI</span>
          </div>
          
          {appState === 'results' && (
             <div className="hidden md:flex items-center gap-6 text-sm font-medium text-gray-500">
                <span className="text-indigo-600">1. Upload</span>
                <ArrowRight className="w-4 h-4 text-gray-300" />
                <span className="text-indigo-600">2. Style</span>
                <ArrowRight className="w-4 h-4 text-gray-300" />
                <span className="text-gray-900">3. Results</span>
             </div>
          )}
        </div>
      </header>

      {/* Main Content */}
      <main className="min-h-[calc(100vh-64px)]">
        {error && (
          <div className="max-w-2xl mx-auto mt-6 px-4">
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-3">
              <AlertCircle className="w-5 h-5 flex-shrink-0" />
              <p>{error}</p>
              <button onClick={() => setError(null)} className="ml-auto hover:bg-red-100 p-1 rounded">
                <X className="w-4 h-4" />
              </button>
            </div>
          </div>
        )}

        {appState === 'landing' && renderLanding()}
        {appState === 'upload' && renderLanding()} {/* Re-use landing for now */}
        {appState === 'styles' && renderStyles()}
        {appState === 'generating' && renderGenerating()}
        {appState === 'results' && renderResults()}
      </main>

      {/* Footer */}
      <footer className="bg-white border-t border-gray-200 py-8 mt-auto">
        <div className="max-w-7xl mx-auto px-4 text-center text-gray-400 text-sm">
          <p>Â© {new Date().getFullYear()} Ax3InteriAI. Powered by Gemini.</p>
        </div>
      </footer>
      
      {/* Global Styles for Animations */}
      <style>{`
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.5s ease-out forwards;
        }
        @keyframes progress {
          0% { transform: scaleX(0); }
          50% { transform: scaleX(0.7); }
          100% { transform: scaleX(0.9); }
        }
        .animate-progress {
          animation: progress 15s ease-out forwards;
        }
      `}</style>
    </div>
  );
}
